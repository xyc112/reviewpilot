// entry/src/main/ets/pages/CourseDetail.ets

import router from '@ohos.router';
import { promptAction } from '@kit.ArkUI';
import { Course, CourseDetail } from '../type/CourseTypes';
import { CourseController } from '../controller/CourseController';

@Entry
@Component
struct courseDetail {
  // è·¯ç”±å‚æ•°
  @State courseId: number = 0;
  @State courseTitle: string = '';

  // æ§åˆ¶å™¨
  private courseController: CourseController = new CourseController('');

  // çŠ¶æ€å˜é‡
  @State courseDetail: CourseDetail | null = null;
  @State isLoading: boolean = false;



  // ç”¨æˆ·è§’è‰²çŠ¶æ€
  @StorageLink('userRole') userRole: string = 'USER';
  @StorageLink('userId') userId: number = 0;
  @StorageLink('isLoggedIn') isLoggedIn: boolean = false;

  aboutToAppear() {
    // 1. è·å– Token
    const token = AppStorage.get<string>('userToken') || '';
    this.courseController.setToken(token);

    // 2. è·å–è·¯ç”±å‚æ•°
    const params = router.getParams() as Record<string, Object>;
    if (params) {
      this.courseId = params['courseId'] as number;
      this.courseTitle = params['courseTitle'] as string;

      // 3. åŠ è½½æ•°æ®
      this.loadCourseDetail();
    }
  }

  build() {
    Stack() {
      // åº•å±‚é¡µé¢å†…å®¹
      Column() {
        // 1. é¡¶éƒ¨å¯¼èˆªæ 
        this.buildNavBar()

        if (this.isLoading && !this.courseDetail) {
          this.buildLoading()
        } else {
          Scroll() {
            Column({ space: 20 }) {
              // 2. è¯¾ç¨‹è¯¦æƒ…å¡ç‰‡
              if (this.courseDetail) {
                this.buildCourseInfoCard()
              }

              // 3. è¯¾ç¨‹å¯¼èˆªåŒºåŸŸ
              this.buildCourseNavigation()
            }
            .padding(16)
            .width('100%')
          }
          .layoutWeight(1)
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#f5f5f5')


    }
  }

  // --- UI æ„å»ºæ–¹æ³• ---

  @Builder
  buildNavBar() {
    Row() {
      Button({ type: ButtonType.Normal }) {
        Text('<')
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        router.back();
      })

      Text(this.courseTitle)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .layoutWeight(1)
        .margin({ left: 10 })
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
    }
    .width('100%')
    .height(56)
    .padding({ left: 10, right: 10 })
    .backgroundColor(Color.White)
  }

  @Builder
  buildLoading() {
    Column() {
      LoadingProgress().width(50).height(50)
      Text('åŠ è½½ä¸­...').margin({ top: 10 }).fontColor('#999')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  buildCourseInfoCard() {
    Column({ space: 10 }) {
      Row() {
        Text(this.courseDetail?.title)
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)

        Text(this.courseDetail?.level)
          .fontSize(12)
          .fontColor(Color.White)
          .backgroundColor('#007dff')
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .borderRadius(10)
      }

      // è¯¾ç¨‹æè¿°
      Column({ space: 8 }) {
        Text('è¯¾ç¨‹æè¿°')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .width('100%')

        Text(this.courseDetail?.description || 'æš‚æ— æè¿°')
          .fontSize(14)
          .fontColor('#666')
          .lineHeight(20)
      }
      .width('100%')
      .margin({ top: 10 })

      // è¯¾ç¨‹æ ‡ç­¾
      if (this.courseDetail?.tags && this.courseDetail.tags.length > 0) {
        Column({ space: 8 }) {
          Text('è¯¾ç¨‹æ ‡ç­¾')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')
            .width('100%')

          Flex({ wrap: FlexWrap.Wrap }) {
            ForEach(this.courseDetail.tags, (tag: string) => {
              Text(tag)
                .fontSize(12)
                .fontColor('#666')
                .backgroundColor('#f0f0f0')
                .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                .borderRadius(4)
                .margin({ right: 8, bottom: 8 })
            })
          }
        }
        .width('100%')
        .margin({ top: 10 })
      }

      Text(`åˆ›å»ºæ—¶é—´: ${this.formatDate(this.courseDetail?.createdAt)}`)
        .fontSize(12)
        .fontColor('#999')
        .margin({ top: 5 })

      // ç®¡ç†å‘˜æ“ä½œæŒ‰é’®
      if (this.userRole === 'ADMIN' || (this.courseDetail && this.userId === this.courseDetail.authorId)) {
        Row({ space: 10 }) {
          Button('ç¼–è¾‘è¯¾ç¨‹')
            .backgroundColor('#1890ff')
            .fontColor(Color.White)
            .layoutWeight(1)
            .onClick(() => {
              this.editCourse();
            })

          Button('åˆ é™¤è¯¾ç¨‹')
            .backgroundColor('#ff4d4f')
            .fontColor(Color.White)
            .layoutWeight(1)
            .onClick(() => {
              this.deleteCourse();
            })
        }
        .width('100%')
        .margin({ top: 15 })
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor(Color.White)
    .borderRadius(16)
    .shadow({ radius: 5, color: '#1a000000' })
  }

  @Builder
  buildCourseNavigation() {
    Column({ space: 16 }) {
      Text('è¯¾ç¨‹åŠŸèƒ½')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333')
        .width('100%')
        .margin({ top: 10 })

      Row({ space: 12 }) {
        // çŸ¥è¯†å›¾è°±
        Column({ space: 8 }) {
          Text('ğŸ“Š')
            .fontSize(24)
            .margin({ bottom: 4 })
          
          Text('çŸ¥è¯†å›¾è°±')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333')
          
          Text('å¯è§†åŒ–è¯¾ç¨‹çŸ¥è¯†ç‚¹å…³ç³»')
            .fontSize(12)
            .fontColor('#666')
            .maxLines(2)
            .textAlign(TextAlign.Center)
        }
        .width('30%')
        .padding(16)
        .backgroundColor(Color.White)
        .borderRadius(12)
        .shadow({ radius: 4, color: '#1a000000' })
        .onClick(() => {
          router.pushUrl({
            url: 'pages/GraphView',
            params: { 
              courseId: this.courseId,
              courseTitle: this.courseTitle 
            }
          }).catch((error: Error) => {
            console.error('è·³è½¬åˆ°çŸ¥è¯†å›¾è°±å¤±è´¥:', error);
            promptAction.showToast({ message: 'é¡µé¢è·³è½¬å¤±è´¥' });
          });
        })

        // è¯¾ç¨‹ç¬”è®°
        Column({ space: 8 }) {
          Text('ğŸ“')
            .fontSize(24)
            .margin({ bottom: 4 })
          
          Text('è¯¾ç¨‹ç¬”è®°')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333')
          
          Text('æŸ¥çœ‹å’Œåˆ›å»ºå­¦ä¹ ç¬”è®°')
            .fontSize(12)
            .fontColor('#666')
            .maxLines(2)
            .textAlign(TextAlign.Center)
        }
        .width('30%')
        .padding(16)
        .backgroundColor(Color.White)
        .borderRadius(12)
        .shadow({ radius: 4, color: '#1a000000' })
        .onClick(() => {
          router.pushUrl({
            url: 'pages/NoteList',
            params: { 
              courseId: this.courseId,
              courseTitle: this.courseTitle 
            }
          }).catch((error: Error) => {
            console.error('è·³è½¬åˆ°ç¬”è®°åˆ—è¡¨å¤±è´¥:', error);
            promptAction.showToast({ message: 'é¡µé¢è·³è½¬å¤±è´¥' });
          });
        })

        // è¯¾ç¨‹æµ‹éªŒ
        Column({ space: 8 }) {
          Text('ğŸ§©')
            .fontSize(24)
            .margin({ bottom: 4 })
          
          Text('è¯¾ç¨‹æµ‹éªŒ')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333')
          
          Text('æµ‹è¯•å­¦ä¹ æˆæœ')
            .fontSize(12)
            .fontColor('#666')
            .maxLines(2)
            .textAlign(TextAlign.Center)
        }
        .width('30%')
        .padding(16)
        .backgroundColor(Color.White)
        .borderRadius(12)
        .shadow({ radius: 4, color: '#1a000000' })
        .onClick(() => {
          router.pushUrl({
            url: 'pages/QuizList',
            params: { 
              courseId: this.courseId,
              courseTitle: this.courseTitle 
            }
          }).catch((error: Error) => {
            console.error('è·³è½¬åˆ°è¯¾ç¨‹æµ‹éªŒå¤±è´¥:', error);
            promptAction.showToast({ message: 'é¡µé¢è·³è½¬å¤±è´¥' });
          });
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
    }
    .width('100%')
  }



  // --- é€»è¾‘æ–¹æ³• ---

  // åŠ è½½è¯¾ç¨‹è¯¦æƒ…
  async loadCourseDetail() {
    this.isLoading = true;
    const result = await this.courseController.getCourseDetail(this.courseId);
    if (result.success && result.data) {
      this.courseDetail = result.data;
    } else {
      promptAction.showToast({ message: result.message || 'åŠ è½½è¯¦æƒ…å¤±è´¥' });
    }
    this.isLoading = false;
  }



  // ç¼–è¾‘è¯¾ç¨‹
  private editCourse(): void {
    // è·³è½¬åˆ°ç¼–è¾‘é¡µé¢ï¼Œä¼ é€’è¯¾ç¨‹ID
    try {
      router.pushUrl({ 
        url: 'pages/EditCourse',
        params: { 
          courseId: this.courseId
        }
      });
    } catch (error) {
      console.error('è·³è½¬åˆ°ç¼–è¾‘é¡µé¢å¤±è´¥:', error);
      promptAction.showToast({ message: 'é¡µé¢è·³è½¬å¤±è´¥' });
    }
  }

  // åˆ é™¤è¯¾ç¨‹
  private async deleteCourse(): Promise<void> {
    try {
      // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
      const result = await promptAction.showDialog({
        title: 'åˆ é™¤è¯¾ç¨‹',
        message: `ç¡®å®šè¦åˆ é™¤è¯¾ç¨‹"${this.courseDetail?.title}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,
        buttons: [
          { text: 'å–æ¶ˆ', color: '#666' },
          { text: 'åˆ é™¤', color: '#ff0000' }
        ]
      });

      if (result.index === 1) {
        // ç”¨æˆ·ç¡®è®¤åˆ é™¤
        const deleteResult = await this.courseController.deleteCourse(this.courseId);
        
        if (deleteResult.success) {
          promptAction.showToast({ message: 'è¯¾ç¨‹åˆ é™¤æˆåŠŸ' });
          // è¿”å›ä¸Šä¸€é¡µ
          router.back();
        } else {
          promptAction.showToast({ message: deleteResult.message || 'åˆ é™¤å¤±è´¥' });
        }
      }
    } catch (error) {
      console.error('åˆ é™¤è¯¾ç¨‹å¤±è´¥:', error);
      promptAction.showToast({ message: 'åˆ é™¤è¯¾ç¨‹æ—¶å‘ç”Ÿå¼‚å¸¸' });
    }
  }

  // å·¥å…·ï¼šæ ¼å¼åŒ–æ—¥æœŸ
  formatDate(dateStr?: string): string {
    if (!dateStr) return '';
    try {
      const date = new Date(dateStr);
      return `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
    } catch (e) {
      return dateStr;
    }
  }
}