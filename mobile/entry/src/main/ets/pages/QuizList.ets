// QuizList.ets
import { Quiz } from '../type/QuizTypes';
import { QuizController } from '../controller/QuizController';
import { PromptAction, promptAction } from '@kit.ArkUI';
import router from '@ohos.router';

@Entry
@Component
struct QuizList {
  @StorageLink('username') username: string = 'æœªç™»å½•';
  @StorageLink('userRole') userRole: string = 'USER';
  @StorageLink('isLoggedIn') isLoggedIn: boolean = false;
  
  private quizController: QuizController = new QuizController('');
  @State quizzes: Quiz[] = [];
  @State isLoading: boolean = false;
  @State errorMessage: string = '';
  @State successMessage: string = '';
  private courseId: number = 0;
  private courseTitle: string = '';

  aboutToAppear(): void {
    // ä»è·¯ç”±å‚æ•°è·å–è¯¾ç¨‹ID
    const params = router.getParams() as Record<string, Object>;
    if (params) {
      this.courseId = (params.courseId as number) || 0;
      this.courseTitle = (params.courseTitle as string) || 'æœªçŸ¥è¯¾ç¨‹';
    }
    
    // è·å–tokenå¹¶è®¾ç½®
    const token: string = AppStorage.get<string>('userToken') || '';
    console.log('QuizListé¡µé¢åŠ è½½ï¼Œè¯¾ç¨‹ID:', this.courseId, 'token:', token ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ');
    this.quizController.setToken(token);
    
    if (this.courseId > 0) {
      this.loadQuizzes();
    } else {
      this.errorMessage = 'è¯¾ç¨‹IDæ— æ•ˆ';
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.buildHeader()
      
      // åŠ è½½çŠ¶æ€
      if (this.isLoading) {
        this.buildLoadingIndicator()
      }

      // é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
      if (this.errorMessage) {
        this.buildErrorMessage()
      }

      // æˆåŠŸä¿¡æ¯æ˜¾ç¤º
      if (this.successMessage) {
        this.buildSuccessMessage()
      }

      // æµ‹éªŒåˆ—è¡¨
      if (this.quizzes.length === 0 && !this.isLoading && !this.errorMessage) {
        this.buildEmptyState()
      } else {
        this.buildQuizList()
      }

      // æ·»åŠ æµ‹éªŒæŒ‰é’® - ä»…ç®¡ç†å‘˜å¯è§
      if (this.userRole === 'ADMIN') {
        this.buildAddButton()
      }
    }
    .padding(20)
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }

  // æ„å»ºé¡¶éƒ¨åŒºåŸŸ
  @Builder
  buildHeader() {
    Row() {
      Button('è¿”å›')
        .fontSize(16)
        .backgroundColor('#007dff')
        .onClick(() => {
          router.back();
        })
      
      Column() {
        Text('è¯¾ç¨‹æµ‹éªŒ')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
        
        Text(this.courseTitle)
          .fontSize(14)
          .fontColor('#666')
          .margin({ top: 4 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Center)

      Button('åˆ·æ–°')
        .fontSize(14)
        .backgroundColor('#52c41a')
        .onClick(() => {
          this.loadQuizzes();
        })
    }
    .width('100%')
    .margin({ bottom: 20 })
  }

  // æ„å»ºåŠ è½½æŒ‡ç¤ºå™¨
  @Builder
  buildLoadingIndicator() {
    Row() {
      LoadingProgress()
        .width(30)
        .height(30)
      Text('åŠ è½½ä¸­...')
        .fontSize(16)
        .margin({ left: 10 })
    }
    .justifyContent(FlexAlign.Center)
    .width('100%')
    .padding(20)
  }

  // æ„å»ºé”™è¯¯ä¿¡æ¯
  @Builder
  buildErrorMessage() {
    Text(this.errorMessage)
      .fontSize(14)
      .fontColor(Color.Red)
      .backgroundColor('#ffeeee')
      .padding(10)
      .borderRadius(8)
      .width('100%')
      .margin({ bottom: 10 })
      .onClick(() => {
        this.errorMessage = '';
      })
  }

  // æ„å»ºæˆåŠŸä¿¡æ¯
  @Builder
  buildSuccessMessage() {
    Text(this.successMessage)
      .fontSize(14)
      .fontColor(Color.Green)
      .backgroundColor('#eeffee')
      .padding(10)
      .borderRadius(8)
      .width('100%')
      .margin({ bottom: 10 })
      .onClick(() => {
        this.successMessage = '';
      })
  }

  // æ„å»ºç©ºçŠ¶æ€
  @Builder
  buildEmptyState() {
    Column() {
      Text('ğŸ§©')
        .fontSize(48)
        .margin({ bottom: 16 })
      
      Text('æš‚æ— æµ‹éªŒ')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 8 })
      
      Text(this.userRole === 'ADMIN' ? 'ç«‹å³åˆ›å»ºç¬¬ä¸€ä¸ªæµ‹éªŒå§ï¼' : 'è¯·ç­‰å¾…ç®¡ç†å‘˜åˆ›å»ºæµ‹éªŒã€‚')
        .fontSize(14)
        .fontColor('#666')
        .margin({ bottom: 20 })
        .textAlign(TextAlign.Center)
      
      if (this.userRole === 'ADMIN') {
        Button('åˆ›å»ºæ–°æµ‹éªŒ')
          .fontSize(16)
          .backgroundColor('#007dff')
          .padding({ left: 20, right: 20, top: 8, bottom: 8 })
          .onClick(() => {
            this.createQuiz();
          })
      }
    }
    .justifyContent(FlexAlign.Center)
    .width('100%')
    .layoutWeight(1)
  }

  // æ„å»ºæµ‹éªŒåˆ—è¡¨
  @Builder
  buildQuizList() {
    List({ space: 12 }) {
      ForEach(this.quizzes, (quiz: Quiz) => {
        ListItem() {
          this.buildQuizItem(quiz)
        }
      }, (quiz: Quiz) => quiz.id)
    }
    .layoutWeight(1)
    .width('100%')
  }

  // æ„å»ºæµ‹éªŒé¡¹
  @Builder
  buildQuizItem(quiz: Quiz) {
    Column() {
      Row() {
        Text(quiz.title)
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .layoutWeight(1)
        
        if (quiz.isPublished) {
          Text('å·²å‘å¸ƒ')
            .fontSize(12)
            .fontColor('#52c41a')
            .backgroundColor('#f6ffed')
            .padding({ left: 8, right: 8, top: 2, bottom: 2 })
            .borderRadius(10)
        } else {
          Text('è‰ç¨¿')
            .fontSize(12)
            .fontColor('#666')
            .backgroundColor('#f5f5f5')
            .padding({ left: 8, right: 8, top: 2, bottom: 2 })
            .borderRadius(10)
        }
      }
      .width('100%')
      .margin({ bottom: 8 })

      if (quiz.description) {
        Text(quiz.description)
          .fontSize(14)
          .fontColor('#666')
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
          .margin({ bottom: 8 })
      }

      Row() {
        Text(`é¢˜ç›®æ•°é‡: ${quiz.questions.length}`)
          .fontSize(12)
          .fontColor('#666')
        
        if (quiz.timeLimit) {
          Text(`æ—¶é•¿: ${quiz.timeLimit}åˆ†é’Ÿ`)
            .fontSize(12)
            .fontColor('#666')
            .margin({ left: 16 })
        }
        
        Text(`åŠæ ¼åˆ†: ${quiz.passingScore}`)
          .fontSize(12)
          .fontColor('#666')
          .margin({ left: 16 })
      }
      .width('100%')
      .margin({ bottom: 12 })

      Row() {
        Button('å¼€å§‹æµ‹éªŒ')
          .fontSize(12)
          .backgroundColor('#52c41a')
          .onClick(() => {
            this.startQuiz(quiz.id);
          })
        
        if (this.userRole === 'ADMIN') {
          Button('ç¼–è¾‘')
            .fontSize(12)
            .backgroundColor('#1890ff')
            .margin({ left: 8 })
            .onClick(() => {
              this.editQuiz(quiz.id);
            })
          
          Button('åˆ é™¤')
            .fontSize(12)
            .backgroundColor('#ff4d4f')
            .margin({ left: 8 })
            .onClick(() => {
              this.deleteQuiz(quiz.id);
            })
        }
      }
      .width('100%')
      .justifyContent(FlexAlign.End)
    }
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({ radius: 2, color: '#1a000000', offsetX: 0, offsetY: 1 })
  }

  // æ„å»ºæ·»åŠ æŒ‰é’®
  @Builder
  buildAddButton() {
    Button('åˆ›å»ºæ–°æµ‹éªŒ')
      .width('100%')
      .height(44)
      .fontSize(16)
      .fontWeight(FontWeight.Medium)
      .backgroundColor('#007dff')
      .fontColor(Color.White)
      .borderRadius(8)
      .margin({ top: 20 })
      .onClick(() => {
        this.createQuiz();
      })
  }

  // åŠ è½½æµ‹éªŒåˆ—è¡¨
  private async loadQuizzes(): Promise<void> {
    this.isLoading = true;
    this.errorMessage = '';

    try {
      console.log('å¼€å§‹åŠ è½½æµ‹éªŒåˆ—è¡¨ï¼Œè¯¾ç¨‹ID:', this.courseId);
      const result = await this.quizController.listQuizzes(this.courseId);

      if (result.success && result.data) {
        this.quizzes = result.data;
        this.successMessage = `å…±åŠ è½½ ${result.total} ä¸ªæµ‹éªŒ`;
        console.log('æµ‹éªŒåŠ è½½æˆåŠŸï¼Œæµ‹éªŒæ•°é‡:', result.data.length);
      } else {
        this.errorMessage = result.message || 'åŠ è½½æµ‹éªŒå¤±è´¥';
        console.error('æµ‹éªŒåŠ è½½å¤±è´¥:', result.message);
      }
    } catch (error) {
      this.errorMessage = 'åŠ è½½æµ‹éªŒæ—¶å‘ç”Ÿå¼‚å¸¸: ' + (error as Error).message;
      console.error('æµ‹éªŒåŠ è½½å¼‚å¸¸:', error);
    } finally {
      this.isLoading = false;
    }
  }

  // å¼€å§‹æµ‹éªŒ
  private startQuiz(quizId: string): void {
    try {
      console.log('å¼€å§‹æµ‹éªŒï¼Œæµ‹éªŒID:', quizId);
      router.pushUrl({ 
        url: 'pages/QuizDetail',
        params: { 
          courseId: this.courseId,
          quizId: quizId 
        }
      });
    } catch (error) {
      console.error('è·³è½¬åˆ°æµ‹éªŒé¡µé¢å¤±è´¥:', error);
      this.errorMessage = 'é¡µé¢è·³è½¬å¤±è´¥: ' + (error as Error).message;
    }
  }

  // åˆ›å»ºæµ‹éªŒ
  private createQuiz(): void {
    try {
      console.log('åˆ›å»ºæ–°æµ‹éªŒ');
      router.pushUrl({ 
        url: 'pages/CreateQuiz',
        params: { 
          courseId: this.courseId,
          courseTitle: this.courseTitle
        }
      });
    } catch (error) {
      console.error('è·³è½¬åˆ°åˆ›å»ºæµ‹éªŒé¡µé¢å¤±è´¥:', error);
      this.errorMessage = 'é¡µé¢è·³è½¬å¤±è´¥: ' + (error as Error).message;
    }
  }

  // ç¼–è¾‘æµ‹éªŒ
  private editQuiz(quizId: string): void {
    try {
      console.log('ç¼–è¾‘æµ‹éªŒï¼Œæµ‹éªŒID:', quizId);
      router.pushUrl({ 
        url: 'pages/EditQuiz',
        params: { 
          courseId: this.courseId,
          quizId: quizId 
        }
      });
    } catch (error) {
      console.error('è·³è½¬åˆ°ç¼–è¾‘æµ‹éªŒé¡µé¢å¤±è´¥:', error);
      this.errorMessage = 'é¡µé¢è·³è½¬å¤±è´¥: ' + (error as Error).message;
    }
  }

  // åˆ é™¤æµ‹éªŒ
  private async deleteQuiz(quizId: string): Promise<void> {
    try {
      promptAction.showDialog({
        title: 'ç¡®è®¤åˆ é™¤',
        message: 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæµ‹éªŒå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
        buttons: [
          { text: 'å–æ¶ˆ', color: '#666' },
          { text: 'åˆ é™¤', color: '#ff4d4f' }
        ]
      }).then(async (result: promptAction.ShowDialogSuccessResponse) => {
        if (result.index === 1) {
          console.log('ç¡®è®¤åˆ é™¤æµ‹éªŒï¼Œæµ‹éªŒID:', quizId);
          const deleteResult = await this.quizController.deleteQuiz(this.courseId, quizId);
          
          if (deleteResult.success) {
            this.successMessage = 'æµ‹éªŒåˆ é™¤æˆåŠŸ';
            this.loadQuizzes(); // é‡æ–°åŠ è½½åˆ—è¡¨
          } else {
            this.errorMessage = deleteResult.message || 'åˆ é™¤æµ‹éªŒå¤±è´¥';
          }
        }
      });
    } catch (error) {
      console.error('åˆ é™¤æµ‹éªŒå¤±è´¥:', error);
      this.errorMessage = 'åˆ é™¤æµ‹éªŒæ—¶å‘ç”Ÿå¼‚å¸¸: ' + (error as Error).message;
    }
  }
}