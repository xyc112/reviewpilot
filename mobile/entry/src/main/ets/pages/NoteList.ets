// entry/src/main/ets/pages/NoteList.ets

import router from '@ohos.router';
import { promptAction } from '@kit.ArkUI';
import { Note, CreateNoteRequest, UpdateNoteRequest, NoteOperationResponse } from '../type/NoteTypes';
import { NoteController } from '../controller/NoteController';

// å®šä¹‰æŒ‰é’®æ¥å£
interface DialogButton {
  text: string;
  color: string;
}

@Entry
@Component
struct NoteList {
  // è·¯ç”±å‚æ•°
  @State courseId: number = 0;
  @State courseTitle: string = '';

  // æ§åˆ¶å™¨
  private noteController: NoteController = new NoteController('');

  // çŠ¶æ€å˜é‡
  @State noteList: Note[] = [];
  @State isLoading: boolean = false;
  @State error: string = '';

  // ç¬”è®°è¡¨å•çŠ¶æ€
  @State isNoteFormVisible: boolean = false;
  @State editingNote: Note | null = null;
  @State noteForm: CreateNoteRequest = {
    title: '',
    content: ''
  };
  @State isSubmitting: boolean = false;

  // é€‰ä¸­æŸ¥çœ‹çš„ç¬”è®°
  @State selectedNote: Note | null = null;

  // ç”¨æˆ·è§’è‰²çŠ¶æ€
  @StorageLink('userRole') userRole: string = 'USER';
  @StorageLink('userId') userId: number = 0;

  aboutToAppear() {
    // 1. è·å– Token
    const token = AppStorage.get<string>('userToken') || '';
    this.noteController.setToken(token);

    // 2. è·å–è·¯ç”±å‚æ•°
    const params = router.getParams() as Record<string, Object>;
    if (params) {
      this.courseId = params.courseId as number;
      this.courseTitle = params.courseTitle as string;

      // 3. åŠ è½½æ•°æ®
      this.loadNotes();
    }
  }

  build() {
    Stack() {
      // åº•å±‚é¡µé¢å†…å®¹
      Column() {
        // 1. é¡¶éƒ¨å¯¼èˆªæ 
        this.buildNavBar()

        if (this.isLoading) {
          this.buildLoading()
        } else {
          Column({ space: 16 }) {
            // 2. é”™è¯¯æç¤º
            if (this.error) {
              this.buildError()
            }

            // 3. ç¬”è®°åˆ—è¡¨
            this.buildNotesList()
          }
          .padding(16)
          .width('100%')
          .layoutWeight(1)
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#f5f5f5')

      // ä¸Šå±‚å¼¹çª—ï¼šæ·»åŠ /ç¼–è¾‘ç¬”è®°
      if (this.isNoteFormVisible) {
        this.buildNoteFormDialog()
      }

      // ä¸Šå±‚å¼¹çª—ï¼šæŸ¥çœ‹ç¬”è®°è¯¦æƒ…
      if (this.selectedNote) {
        this.buildNoteDetailDialog()
      }
    }
  }

  // --- UI æ„å»ºæ–¹æ³• ---

  @Builder
  buildNavBar() {
    Row() {
      Button({ type: ButtonType.Normal }) {
        Text('<')
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        router.back();
      })

      Text(`${this.courseTitle} - ç¬”è®°`)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .layoutWeight(1)
        .margin({ left: 10 })
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })

      Button('+')
        .width(40)
        .height(40)
        .backgroundColor('#007dff')
        .fontColor(Color.White)
        .onClick(() => {
          this.showCreateNoteForm();
        })
    }
    .width('100%')
    .height(56)
    .padding({ left: 10, right: 10 })
    .backgroundColor(Color.White)
  }

  @Builder
  buildLoading() {
    Column() {
      LoadingProgress().width(50).height(50)
      Text('åŠ è½½ç¬”è®°åˆ—è¡¨ä¸­...').margin({ top: 10 }).fontColor('#999')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  buildError() {
    Row() {
      Text(this.error)
        .fontSize(14)
        .fontColor(Color.Red)
        .layoutWeight(1)

      Button('é‡è¯•')
        .fontSize(12)
        .height(28)
        .onClick(() => {
          this.error = '';
          this.loadNotes();
        })
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#ffebee')
    .borderRadius(8)
  }

  @Builder
  buildNotesList() {
    if (this.noteList.length === 0) {
      Column() {
        Text('ğŸ“')
          .fontSize(48)
          .margin({ bottom: 16 })

        Text('æš‚æ— ç¬”è®°')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#666')
          .margin({ bottom: 8 })

        Text('ç‚¹å‡»å³ä¸Šè§’çš„ + æŒ‰é’®åˆ›å»ºç¬¬ä¸€æ¡ç¬”è®°')
          .fontSize(14)
          .fontColor('#999')
          .textAlign(TextAlign.Center)
      }
      .width('100%')
      .height(300)
      .justifyContent(FlexAlign.Center)
    } else {
      List({ space: 12 }) {
        ForEach(this.noteList, (note: Note) => {
          ListItem() {
            this.buildNoteCard(note)
          }
        }, (note: Note) => `${note.id}`)
      }
      .width('100%')
    }
  }

  @Builder
  buildNoteCard(note: Note) {
    Column({ space: 12 }) {
      // ç¬”è®°å¤´éƒ¨
      Row() {
        Text(note.title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333')
          .layoutWeight(1)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        // ä½œè€…ä¿¡æ¯ï¼ˆå¦‚æœä¸æ˜¯å½“å‰ç”¨æˆ·ï¼‰
        if (note.authorId !== this.userId) {
          Text(`ä½œè€…ID: ${note.authorId}`)
            .fontSize(12)
            .fontColor('#999')
        }
      }
      .width('100%')

      // ç¬”è®°å†…å®¹é¢„è§ˆ
      Text(note.content)
        .fontSize(14)
        .fontColor('#666')
        .maxLines(3)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .lineHeight(20)
        .width('100%')

      // ç¬”è®°åº•éƒ¨ä¿¡æ¯
      Row() {
        Text(this.formatDate(note.createdAt))
          .fontSize(12)
          .fontColor('#999')

        if (note.updatedAt && note.updatedAt !== note.createdAt) {
          Text(`æ›´æ–°äº ${this.formatDate(note.updatedAt)}`)
            .fontSize(12)
            .fontColor('#999')
            .margin({ left: 8 })
        }

        Blank()

        // æ“ä½œæŒ‰é’®
        Row({ space: 8 }) {
          // æŸ¥çœ‹æŒ‰é’®
          Button('æŸ¥çœ‹')
            .fontSize(12)
            .height(28)
            .backgroundColor('#e3f2fd')
            .fontColor('#1976d2')
            .onClick(() => {
              this.viewNote(note);
            })

          // ç¼–è¾‘æŒ‰é’®ï¼ˆä»…ä½œè€…å’Œç®¡ç†å‘˜å¯è§ï¼‰
          if (this.canEditNote(note)) {
            Button('ç¼–è¾‘')
              .fontSize(12)
              .height(28)
              .backgroundColor('#e8f5e8')
              .fontColor('#388e3c')
              .onClick(() => {
                this.showEditNoteForm(note);
              })
          }

          // åˆ é™¤æŒ‰é’®ï¼ˆä»…ä½œè€…å’Œç®¡ç†å‘˜å¯è§ï¼‰
          if (this.canEditNote(note)) {
            Button('åˆ é™¤')
              .fontSize(12)
              .height(28)
              .backgroundColor('#ffebee')
              .fontColor('#d32f2f')
              .onClick(() => {
                this.deleteNote(note.id);
              })
          }
        }
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .shadow({ radius: 4, color: '#1a000000' })
    .onClick(() => {
      this.viewNote(note);
    })
  }

  @Builder
  buildNoteFormDialog() {
    Stack() {
      // è’™å±‚
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .onClick(() => {
          if (!this.isSubmitting) this.hideNoteForm();
        })

      // å¯¹è¯æ¡†å†…å®¹
      Column({ space: 16 }) {
        Text(this.editingNote ? 'ç¼–è¾‘ç¬”è®°' : 'åˆ›å»ºæ–°ç¬”è®°')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)

        TextInput({ placeholder: 'è¯·è¾“å…¥ç¬”è®°æ ‡é¢˜', text: this.noteForm.title })
          .onChange((val) => {
            this.noteForm.title = val;
          })
          .backgroundColor('#f9f9f9')
          .borderRadius(8)

        TextArea({ 
          placeholder: 'è¯·è¾“å…¥ç¬”è®°å†…å®¹...', 
          text: this.noteForm.content 
        })
          .height(120)
          .onChange((val) => {
            this.noteForm.content = val;
          })
          .backgroundColor('#f9f9f9')
          .borderRadius(8)

        Row({ space: 12 }) {
          Button('å–æ¶ˆ')
            .backgroundColor('#f0f0f0')
            .fontColor('#666')
            .layoutWeight(1)
            .onClick(() => this.hideNoteForm())

          Button(this.isSubmitting ? 'æäº¤ä¸­...' : 'ä¿å­˜')
            .backgroundColor('#007dff')
            .fontColor(Color.White)
            .layoutWeight(1)
            .enabled(!this.isSubmitting)
            .onClick(() => this.submitNote())
        }
        .width('100%')
      }
      .width('90%')
      .padding(20)
      .backgroundColor(Color.White)
      .borderRadius(16)
    }
    .width('100%')
    .height('100%')
    .zIndex(999)
  }

  @Builder
  buildNoteDetailDialog() {
    Stack() {
      // è’™å±‚
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.5)')
        .onClick(() => {
          this.selectedNote = null;
        })

      // å¯¹è¯æ¡†å†…å®¹
      Column({ space: 16 }) {
        // æ ‡é¢˜æ 
        Row() {
          Text(this.selectedNote?.title || '')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .layoutWeight(1)

          Button('å…³é—­')
            .fontSize(14)
            .height(32)
            .backgroundColor('#f0f0f0')
            .fontColor('#666')
            .onClick(() => {
              this.selectedNote = null;
            })
        }
        .width('100%')

        // ç¬”è®°ä¿¡æ¯
        Row() {
          Text(`åˆ›å»ºæ—¶é—´: ${this.formatDate(this.selectedNote?.createdAt)}`)
            .fontSize(12)
            .fontColor('#999')

          if (this.selectedNote?.updatedAt && this.selectedNote.updatedAt !== this.selectedNote.createdAt) {
            Text(`æ›´æ–°æ—¶é—´: ${this.formatDate(this.selectedNote.updatedAt)}`)
              .fontSize(12)
              .fontColor('#999')
              .margin({ left: 12 })
          }
        }
        .width('100%')

        Divider().color('#f0f0f0')

        // ç¬”è®°å†…å®¹
        Scroll() {
          Text(this.selectedNote?.content || '')
            .fontSize(14)
            .fontColor('#333')
            .lineHeight(22)
            .width('100%')
        }
        .layoutWeight(1)
        .width('100%')

        // æ“ä½œæŒ‰é’®
        if (this.selectedNote && this.canEditNote(this.selectedNote)) {
          Row({ space: 12 }) {
            Button('ç¼–è¾‘')
              .backgroundColor('#007dff')
              .fontColor(Color.White)
              .layoutWeight(1)
              .onClick(() => {
                this.showEditNoteForm(this.selectedNote!);
                this.selectedNote = null;
              })

            Button('åˆ é™¤')
              .backgroundColor('#ff4d4f')
              .fontColor(Color.White)
              .layoutWeight(1)
              .onClick(() => {
                this.deleteNote(this.selectedNote!.id);
                this.selectedNote = null;
              })
          }
          .width('100%')
        }
      }
      .width('90%')
      .height('80%')
      .padding(20)
      .backgroundColor(Color.White)
      .borderRadius(16)
    }
    .width('100%')
    .height('100%')
    .zIndex(998)
  }

  // --- é€»è¾‘æ–¹æ³• ---

  // åŠ è½½ç¬”è®°åˆ—è¡¨
  async loadNotes() {
    this.isLoading = true;
    const result = await this.noteController.listNotes(this.courseId);
    if (result.success && result.data) {
      this.noteList = result.data;
      this.error = '';
    } else {
      this.error = result.message || 'åŠ è½½ç¬”è®°å¤±è´¥';
    }
    this.isLoading = false;
  }

  // æ˜¾ç¤ºåˆ›å»ºç¬”è®°è¡¨å•
  showCreateNoteForm() {
    this.editingNote = null;
    this.noteForm = { title: '', content: '' };
    this.isNoteFormVisible = true;
  }

  // æ˜¾ç¤ºç¼–è¾‘ç¬”è®°è¡¨å•
  showEditNoteForm(note: Note) {
    this.editingNote = note;
    this.noteForm = {
      title: note.title,
      content: note.content
    };
    this.isNoteFormVisible = true;
  }

  // éšè—ç¬”è®°è¡¨å•
  hideNoteForm() {
    this.isNoteFormVisible = false;
    this.editingNote = null;
    this.noteForm = { title: '', content: '' };
  }

  // æäº¤ç¬”è®°
  async submitNote() {
    if (!this.noteForm.title.trim() || !this.noteForm.content.trim()) {
      promptAction.showToast({ message: 'è¯·å¡«å†™å®Œæ•´çš„æ ‡é¢˜å’Œå†…å®¹' });
      return;
    }

    this.isSubmitting = true;

    let result: NoteOperationResponse;
    if (this.editingNote) {
      // æ›´æ–°ç¬”è®°
      const updateData: UpdateNoteRequest = {
        title: this.noteForm.title,
        content: this.noteForm.content
      };
      result = await this.noteController.updateNote(this.courseId, this.editingNote.id, updateData);
    } else {
      // åˆ›å»ºç¬”è®°
      result = await this.noteController.createNote(this.courseId, this.noteForm);
    }

    if (result.success) {
      promptAction.showToast({ 
        message: this.editingNote ? 'ç¬”è®°æ›´æ–°æˆåŠŸ' : 'ç¬”è®°åˆ›å»ºæˆåŠŸ' 
      });
      this.hideNoteForm();
      this.loadNotes(); // åˆ·æ–°åˆ—è¡¨
    } else {
      promptAction.showToast({ message: result.message || 'æ“ä½œå¤±è´¥' });
    }

    this.isSubmitting = false;
  }

  // æŸ¥çœ‹ç¬”è®°è¯¦æƒ…
  viewNote(note: Note) {
    this.selectedNote = note;
  }

  // åˆ é™¤ç¬”è®°
  async deleteNote(noteId: string) {
    const button1: DialogButton = { text: 'å–æ¶ˆ', color: '#666' };
    const button2: DialogButton = { text: 'åˆ é™¤', color: '#ff0000' };
    
    promptAction.showDialog({
      title: 'åˆ é™¤ç¬”è®°',
      message: 'ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¬”è®°å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
      buttons: [button1, button2]
    }).then(async (resp: promptAction.ShowDialogSuccessResponse) => {
      if (resp.index === 1) {
        const result = await this.noteController.deleteNote(this.courseId, noteId);
        if (result.success) {
          promptAction.showToast({ message: 'åˆ é™¤æˆåŠŸ' });
          this.loadNotes(); // åˆ·æ–°åˆ—è¡¨
        } else {
          promptAction.showToast({ message: result.message || 'åˆ é™¤å¤±è´¥' });
        }
      }
    });
  }

  // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç¼–è¾‘ç¬”è®°
  canEditNote(note: Note): boolean {
    return this.userRole === 'ADMIN' || note.authorId === this.userId;
  }

  // æ ¼å¼åŒ–æ—¥æœŸ
  formatDate(dateStr?: string): string {
    if (!dateStr) return '';
    try {
      const date = new Date(dateStr);
      return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    } catch (e) {
      return dateStr;
    }
  }
}