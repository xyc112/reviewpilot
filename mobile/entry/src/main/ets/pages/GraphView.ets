// GraphView.ets
import router from '@ohos.router';
import { promptAction } from '@kit.ArkUI';
import { Node, Relation, NodeType, RelationType, CreateNodeRequest, CreateRelationRequest, ApiCreateRelationRequest } from '../type/GraphTypes';
import { GraphController } from '../controller/GraphController';

interface GeneratedTypeLiteralInterface_1 {
  title: string;
  type: NodeType;
  content: string;
}

interface GeneratedTypeLiteralInterface_2 {
  fromNodeId: string;
  toNodeId: string;
  type: RelationType;
  label: string;
  weight: number;
}

@Entry
@Component
struct GraphView {
  // è·¯ç”±å‚æ•°
  @State courseId: number = 0;
  @State courseTitle: string = '';

  // æ§åˆ¶å™¨
  private graphController: GraphController = new GraphController();

  // çŠ¶æ€å˜é‡
  @State nodes: Node[] = [];
  @State relations: Relation[] = [];
  @State isLoading: boolean = false;
  @State errorMessage: string = '';
  @State selectedNode: Node | null = null;
  @State showNodeForm: boolean = false;
  @State showRelationForm: boolean = false;
  @State showGroupPanel: boolean = false;
  @State showFromNodePicker: boolean = false;
  @State showToNodePicker: boolean = false;
  @State showRelationTypePicker: boolean = false;

  // å…³ç³»ç±»å‹é€‰é¡¹
  private readonly relationTypes: RelationType[] = [RelationType.RELATED, RelationType.PREREQUISITE, RelationType.DEPENDS_ON];

  // è¡¨å•æ•°æ®
  @State nodeForm: GeneratedTypeLiteralInterface_1 = {
    title: '',
    type: NodeType.CONCEPT,
    content: ''
  };

  @State relationForm: GeneratedTypeLiteralInterface_2 = {
    fromNodeId: '',
    toNodeId: '',
    type: RelationType.RELATED,
    label: '',
    weight: 0.5
  };

  // ç”¨æˆ·è§’è‰²
  @StorageLink('userRole') userRole: string = 'USER';

  aboutToAppear() {
    // è·å– Token
    const token = AppStorage.get<string>('userToken') || '';
    this.graphController.setToken(token);

    // è·å–è·¯ç”±å‚æ•°
    const params = router.getParams() as Record<string, Object>;
    if (params) {
      this.courseId = params['courseId'] as number;
      this.courseTitle = params['courseTitle'] as string;
      
      // åŠ è½½æ•°æ®
      this.fetchGraphData();
    }
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        this.buildNavBar();

        if (this.isLoading) {
          this.buildLoading();
        } else if (this.errorMessage) {
          this.buildError();
        } else {
          // ä¸»è¦å†…å®¹åŒºåŸŸ
          this.buildMainContent();
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#f5f5f5')

      // èŠ‚ç‚¹åˆ›å»ºè¡¨å•å¼¹çª—
      if (this.showNodeForm) {
        this.buildNodeFormModal();
      }

      // å…³ç³»åˆ›å»ºè¡¨å•å¼¹çª—
      if (this.showRelationForm) {
        this.buildRelationFormModal();
      }
    }
  }

  @Builder
  buildNavBar() {
    Column() {
      // ç¬¬ä¸€è¡Œï¼šè¿”å›æŒ‰é’®å’Œæ ‡é¢˜
      Row() {
        Button({ type: ButtonType.Normal }) {
          Text('< è¿”å›')
        }
        .width(80)
        .height(40)
        .backgroundColor(Color.Transparent)
        .fontColor('#007dff')
        .onClick(() => {
          router.back();
        })

        Text('çŸ¥è¯†å›¾è°±')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .margin({ left: 10 })

        Button({ type: ButtonType.Normal }) {
          Text(this.showGroupPanel ? 'éšè—åˆ†ç»„' : 'ğŸ“¦ åˆ†ç»„')
        }
        .width(100)
        .height(40)
        .backgroundColor('#666')
        .fontColor(Color.White)
        .onClick(() => {
          this.showGroupPanel = !this.showGroupPanel;
        })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor(Color.White)
      .shadow({ radius: 2, color: '#1a000000' })

      // ç¬¬äºŒè¡Œï¼šç®¡ç†å‘˜æ“ä½œæŒ‰é’®
      if (this.userRole === 'ADMIN') {
        Row() {
          Blank()
          Row({ space: 12 }) {
            Button('æ·»åŠ èŠ‚ç‚¹')
              .backgroundColor('#52c41a')
              .fontColor(Color.White)
              .height(36)
              .padding({ left: 16, right: 16 })
              .onClick(() => {
                this.showNodeForm = true;
              })

            Button('åˆ›å»ºæ–°å…³ç³»')
              .backgroundColor('#1890ff')
              .fontColor(Color.White)
              .height(36)
              .padding({ left: 16, right: 16 })
              .onClick(() => {
                this.initializeRelationForm();
                this.showRelationForm = true;
              })
          }
          .margin({ right: 16 })
        }
        .width('100%')
        .height(50)
        .backgroundColor('#fafafa')
        .border({ width: { bottom: 1 }, color: '#e8e8e8' })
      }
    }
  }

  @Builder
  buildLoading() {
    Column() {
      LoadingProgress().width(50).height(50)
      Text('åŠ è½½çŸ¥è¯†å›¾è°±ä¸­...').margin({ top: 10 }).fontColor('#999')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  buildError() {
    Column() {
      Text('âš ï¸')
        .fontSize(48)
        .fontColor('#ff4d4f')
        .margin({ bottom: 16 })
      
      Text(this.errorMessage)
        .fontSize(16)
        .fontColor('#666')
        .textAlign(TextAlign.Center)
        .margin({ bottom: 20 })
      
      Button('é‡è¯•')
        .backgroundColor('#007dff')
        .fontColor(Color.White)
        .onClick(() => {
          this.fetchGraphData();
        })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .padding(20)
  }

  @Builder
  buildMainContent() {
    Row() {
      // å·¦ä¾§åˆ†ç»„é¢æ¿
      if (this.showGroupPanel) {
        this.buildGroupPanel()
      }

      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Column() {
        this.buildGraphVisualization()
        
        if (this.selectedNode) {
          this.buildNodeDetails()
        }
      }
      .layoutWeight(1)
      .margin({ left: 8, right: 8 })
    }
    .width('100%')
    .layoutWeight(1)
    .padding(16)
  }

  @Builder
  buildGroupPanel() {
    Column() {
      Text('åˆ†ç»„ç®¡ç†')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 16 })
      
      Text('åˆ†ç»„åŠŸèƒ½å¼€å‘ä¸­...')
        .fontSize(14)
        .fontColor('#666')
    }
    .width(200)
    .height('100%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .shadow({ radius: 4, color: '#1a000000' })
    .margin({ right: 8 })
  }

  @Builder
  buildGraphVisualization() {
    Column() {
      Row() {
        Text(`çŸ¥è¯†å›¾è°± (${this.nodes.length} èŠ‚ç‚¹, ${this.relations.length} å…³ç³»)`)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
      }
      .width('100%')
      .margin({ bottom: 12 })

      // å›¾è°±å¯è§†åŒ–åŒºåŸŸ
      Scroll() {
        Column({ space: 12 }) {
          // å…ˆæ˜¾ç¤ºæ‰€æœ‰å…³ç³»è¿æ¥
          ForEach(this.relations, (relation: Relation) => {
            this.buildRelationConnection(relation)
          })

          // å†æ˜¾ç¤ºæ‰€æœ‰èŠ‚ç‚¹
          ForEach(this.nodes, (node: Node) => {
            this.buildGraphNode(node)
          })
        }
        .width('100%')
        .padding(16)
      }
      .width('100%')
      .layoutWeight(1)
      .backgroundColor(Color.White)
      .borderRadius(8)
      .shadow({ radius: 4, color: '#1a000000' })
    }
    .width('100%')
    .height('60%')
  }

  @Builder
  buildRelationConnection(relation: Relation) {
    Row() {
      // èµ·å§‹èŠ‚ç‚¹
      Text(this.nodes.find(n => n.id === relation.fromNodeId)?.title || relation.fromNodeId)
        .fontSize(14)
        .fontColor('#333')
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .layoutWeight(1)
        .padding(8)
        .backgroundColor('#e6f7ff')
        .borderRadius(6)
        .border({ width: 1, color: '#1890ff' })

      // å…³ç³»ç®­å¤´å’Œæ ‡ç­¾
      Column({ space: 2 }) {
        Text('â†’')
          .fontSize(16)
          .fontColor('#1890ff')
        Text(this.getRelationTypeLabel(relation.type))
          .fontSize(10)
          .fontColor('#666')
          .backgroundColor('#f0f0f0')
          .padding({ left: 4, right: 4, top: 1, bottom: 1 })
          .borderRadius(3)
      }
      .width(60)
      .justifyContent(FlexAlign.Center)

      // ç›®æ ‡èŠ‚ç‚¹
      Text(this.nodes.find(n => n.id === relation.toNodeId)?.title || relation.toNodeId)
        .fontSize(14)
        .fontColor('#333')
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
        .layoutWeight(1)
        .padding(8)
        .backgroundColor('#f6ffed')
        .borderRadius(6)
        .border({ width: 1, color: '#52c41a' })

      // åˆ é™¤æŒ‰é’®ï¼ˆç®¡ç†å‘˜ï¼‰
      if (this.userRole === 'ADMIN') {
        Button('Ã—')
          .width(24)
          .height(24)
          .fontSize(14)
          .backgroundColor('#ff4d4f')
          .fontColor(Color.White)
          .margin({ left: 8 })
          .onClick(() => {
            this.handleDeleteRelation(relation.id);
          })
      }
    }
    .width('100%')
    .alignItems(VerticalAlign.Center)
    .padding({ left: 8, right: 8 })
  }

  @Builder
  buildGraphNode(node: Node) {
    Row() {
      // èŠ‚ç‚¹å›¾æ ‡
      Column() {
        Text('â—')
          .fontSize(24)
          .fontColor(this.getNodeColor(node.type))
      }
      .width(40)
      .justifyContent(FlexAlign.Center)

      // èŠ‚ç‚¹ä¿¡æ¯
      Column({ space: 4 }) {
        Text(node.title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333')
        
        Row({ space: 8 }) {
          Text(node.type)
            .fontSize(12)
            .fontColor('#666')
            .backgroundColor('#f0f0f0')
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .borderRadius(4)
          
          Text(`ID: ${node.id}`)
            .fontSize(12)
            .fontColor('#999')
          
          Text(`å…¥åº¦: ${this.getIncomingRelations(node.id).length} | å‡ºåº¦: ${this.getOutgoingRelations(node.id).length}`)
            .fontSize(12)
            .fontColor('#666')
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // æ“ä½œæŒ‰é’®
      Column({ space: 4 }) {
        Button('æŸ¥çœ‹')
          .width(60)
          .height(32)
          .fontSize(12)
          .backgroundColor('#007dff')
          .fontColor(Color.White)
          .onClick(() => {
            this.selectedNode = node;
          })

        if (this.userRole === 'ADMIN') {
          Button('åˆ é™¤')
            .width(60)
            .height(32)
            .fontSize(12)
            .backgroundColor('#ff4d4f')
            .fontColor(Color.White)
            .onClick(() => {
              this.handleDeleteNode(node.id);
            })
        }
      }
    }
    .width('100%')
    .padding(12)
    .backgroundColor(this.selectedNode?.id === node.id ? '#e6f7ff' : Color.White)
    .borderRadius(8)
    .border({ width: 1, color: this.selectedNode?.id === node.id ? '#007dff' : '#f0f0f0' })
    .shadow({ radius: 2, color: '#1a000000' })
    .onClick(() => {
      this.selectedNode = node;
    })
  }

  // è·å–èŠ‚ç‚¹é¢œè‰²
  getNodeColor(type: NodeType): string {
    switch (type) {
      case NodeType.CONCEPT:
        return '#1890ff';
      case NodeType.EXAMPLE:
        return '#52c41a';
      case NodeType.EXERCISE:
        return '#fa8c16';
      case NodeType.RESOURCE:
        return '#722ed1';
      default:
        return '#666';
    }
  }

  @Builder
  buildNodeItem(node: Node) {
    Row() {
      Column({ space: 4 }) {
        Text(node.title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#333')
        
        Row({ space: 8 }) {
          Text(node.type)
            .fontSize(12)
            .fontColor('#666')
            .backgroundColor('#f0f0f0')
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .borderRadius(4)
          
          Text(`ID: ${node.id}`)
            .fontSize(12)
            .fontColor('#999')
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      Column({ space: 4 }) {
        Text(`å…¥åº¦: ${this.getIncomingRelations(node.id).length}`)
          .fontSize(12)
          .fontColor('#666')
        
        Text(`å‡ºåº¦: ${this.getOutgoingRelations(node.id).length}`)
          .fontSize(12)
          .fontColor('#666')
      }

      Column({ space: 4 }) {
        Button('æŸ¥çœ‹')
          .width(60)
          .height(32)
          .fontSize(12)
          .backgroundColor('#007dff')
          .fontColor(Color.White)
          .onClick(() => {
            this.selectedNode = node;
          })

        if (this.userRole === 'ADMIN') {
          Button('åˆ é™¤')
            .width(60)
            .height(32)
            .fontSize(12)
            .backgroundColor('#ff4d4f')
            .fontColor(Color.White)
            .onClick(() => {
              this.handleDeleteNode(node.id);
            })
        }
      }
    }
    .width('100%')
    .padding(12)
    .backgroundColor(this.selectedNode?.id === node.id ? '#e6f7ff' : Color.White)
    .borderRadius(6)
    .border({ width: 1, color: this.selectedNode?.id === node.id ? '#007dff' : '#f0f0f0' })
    .onClick(() => {
      this.selectedNode = node;
    })
  }

  @Builder
  buildNodeDetails() {
    Column() {
      Row() {
        Text('èŠ‚ç‚¹è¯¦æƒ…')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)

        Button('å…³é—­')
          .width(60)
          .height(32)
          .fontSize(12)
          .backgroundColor('#666')
          .fontColor(Color.White)
          .onClick(() => {
            this.selectedNode = null;
          })
      }
      .width('100%')
      .margin({ bottom: 16 })

      Scroll() {
        Column({ space: 12 }) {
          // åŸºæœ¬ä¿¡æ¯
          Column({ space: 8 }) {
            Text('åŸºæœ¬ä¿¡æ¯')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333')

            Row() {
              Text('æ ‡é¢˜:')
                .fontSize(14)
                .fontColor('#666')
                .width(60)
              Text(this.selectedNode?.title || '')
                .fontSize(14)
                .fontColor('#333')
                .layoutWeight(1)
            }

            Row() {
              Text('ç±»å‹:')
                .fontSize(14)
                .fontColor('#666')
                .width(60)
              Text(this.selectedNode?.type || '')
                .fontSize(14)
                .fontColor('#333')
                .layoutWeight(1)
            }

            Row() {
              Text('ID:')
                .fontSize(14)
                .fontColor('#666')
                .width(60)
              Text(this.selectedNode?.id || '')
                .fontSize(14)
                .fontColor('#333')
                .layoutWeight(1)
            }

            if (this.selectedNode?.content) {
              Row() {
                Text('å†…å®¹:')
                  .fontSize(14)
                  .fontColor('#666')
                  .width(60)
                Text(this.selectedNode.content)
                  .fontSize(14)
                  .fontColor('#333')
                  .layoutWeight(1)
                  .maxLines(3)
              }
            }
          }
          .width('100%')
          .padding(12)
          .backgroundColor('#fafafa')
          .borderRadius(6)

          // ç›¸å…³å…³ç³»
          this.buildNodeRelations()
        }
        .width('100%')
      }
      .width('100%')
      .layoutWeight(1)
    }
    .width('100%')
    .height('50%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(8)
    .shadow({ radius: 4, color: '#1a000000' })
    .margin({ top: 8 })
  }

  @Builder
  buildNodeRelations() {
    Column({ space: 12 }) {
      Text('ç›¸å…³å…³ç³»')
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333')

      if (this.getOutgoingRelations(this.selectedNode?.id || '').length > 0) {
        Column({ space: 8 }) {
          Text(`å‡ºè¾¹ (${this.getOutgoingRelations(this.selectedNode?.id || '').length}):`)
            .fontSize(14)
            .fontColor('#666')

          ForEach(this.getOutgoingRelations(this.selectedNode?.id || ''), (relation: Relation) => {
            Row() {
              Text('â†’')
                .fontSize(14)
                .fontColor('#52c41a')
                .margin({ right: 8 })
              Text(this.nodes.find(n => n.id === relation.toNodeId)?.title || relation.toNodeId)
                .fontSize(14)
                .fontColor('#333')
                .layoutWeight(1)
              Text(this.getRelationTypeLabel(relation.type))
                .fontSize(12)
                .fontColor('#666')
                .backgroundColor('#f0f0f0')
                .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                .borderRadius(4)
            }
            .width('100%')
            .padding(8)
            .backgroundColor('#f9f9f9')
            .borderRadius(4)
          })
        }
      }

      if (this.getIncomingRelations(this.selectedNode?.id || '').length > 0) {
        Column({ space: 8 }) {
          Text(`å…¥è¾¹ (${this.getIncomingRelations(this.selectedNode?.id || '').length}):`)
            .fontSize(14)
            .fontColor('#666')

          ForEach(this.getIncomingRelations(this.selectedNode?.id || ''), (relation: Relation) => {
            Row() {
              Text('â†')
                .fontSize(14)
                .fontColor('#1890ff')
                .margin({ right: 8 })
              Text(this.nodes.find(n => n.id === relation.fromNodeId)?.title || relation.fromNodeId)
                .fontSize(14)
                .fontColor('#333')
                .layoutWeight(1)
              Text(this.getRelationTypeLabel(relation.type))
                .fontSize(12)
                .fontColor('#666')
                .backgroundColor('#f0f0f0')
                .padding({ left: 6, right: 6, top: 2, bottom: 2 })
                .borderRadius(4)
            }
            .width('100%')
            .padding(8)
            .backgroundColor('#f9f9f9')
            .borderRadius(4)
          })
        }
      }

      if (this.getIncomingRelations(this.selectedNode?.id || '').length === 0 && 
          this.getOutgoingRelations(this.selectedNode?.id || '').length === 0) {
        Text('æ­¤èŠ‚ç‚¹æš‚æ— å…³è”å…³ç³»')
          .fontSize(14)
          .fontColor('#999')
          .textAlign(TextAlign.Center)
          .width('100%')
          .padding(20)
      }
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#fafafa')
    .borderRadius(6)
  }



  @Builder
  buildRelationItem(relation: Relation) {
    Column({ space: 8 }) {
      Row() {
        Text(this.nodes.find(n => n.id === relation.fromNodeId)?.title || relation.fromNodeId)
          .fontSize(14)
          .fontColor('#333')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .layoutWeight(1)

        Text('â†’')
          .fontSize(14)
          .fontColor('#1890ff')
          .margin({ left: 4, right: 4 })

        Text(this.nodes.find(n => n.id === relation.toNodeId)?.title || relation.toNodeId)
          .fontSize(14)
          .fontColor('#333')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .layoutWeight(1)
      }
      .width('100%')

      Row() {
        Text(this.getRelationTypeLabel(relation.type))
          .fontSize(12)
          .fontColor('#666')
          .backgroundColor('#f0f0f0')
          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
          .borderRadius(4)
          .layoutWeight(1)

        if (relation.weight !== undefined) {
          Text(`æƒé‡: ${relation.weight.toFixed(2)}`)
            .fontSize(12)
            .fontColor('#999')
        }
      }
      .width('100%')

      if (this.userRole === 'ADMIN') {
        Button('åˆ é™¤å…³ç³»')
          .width('100%')
          .height(32)
          .fontSize(12)
          .backgroundColor('#ff4d4f')
          .fontColor(Color.White)
          .onClick(() => {
            this.handleDeleteRelation(relation.id);
          })
      }
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#fafafa')
    .borderRadius(6)
    .border({ width: 1, color: '#f0f0f0' })
  }

  @Builder
  buildNodeFormModal() {
    Stack() {
      // åŠé€æ˜é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .onClick(() => {
          this.showNodeForm = false;
        })

      // è¡¨å•å†…å®¹
      Column() {
        Text('åˆ›å»ºæ–°èŠ‚ç‚¹')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 20 })

        Scroll() {
          Column({ space: 16 }) {
            // èŠ‚ç‚¹æ ‡é¢˜
            Column({ space: 8 }) {
              Text('èŠ‚ç‚¹æ ‡é¢˜:')
                .fontSize(14)
                .fontColor('#333')
              
              TextInput({ placeholder: 'è¾“å…¥èŠ‚ç‚¹åç§°' })
                .width('100%')
                .height(40)
                .fontSize(14)
                .backgroundColor('#f5f5f5')
                .borderRadius(6)
                .onChange((value: string) => {
                  this.nodeForm.title = value;
                })
            }

            // èŠ‚ç‚¹ç±»å‹
            Column({ space: 8 }) {
              Text('èŠ‚ç‚¹ç±»å‹:')
                .fontSize(14)
                .fontColor('#333')
              
              Row({ space: 8 }) {
                ForEach(Object.values(NodeType), (type: NodeType) => {
                  Button(type)
                    .width(80)
                    .height(32)
                    .fontSize(12)
                    .backgroundColor(this.nodeForm.type === type ? '#007dff' : '#f0f0f0')
                    .fontColor(this.nodeForm.type === type ? Color.White : '#666')
                    .onClick(() => {
                      this.nodeForm.type = type;
                    })
                })
              }
            }

            // èŠ‚ç‚¹å†…å®¹
            Column({ space: 8 }) {
              Text('æè¿°:')
                .fontSize(14)
                .fontColor('#333')
              
              TextArea({ placeholder: 'è¾“å…¥èŠ‚ç‚¹æè¿°ï¼ˆå¯é€‰ï¼‰' })
                .width('100%')
                .height(80)
                .fontSize(14)
                .backgroundColor('#f5f5f5')
                .borderRadius(6)
                .onChange((value: string) => {
                  this.nodeForm.content = value;
                })
            }
          }
          .width('100%')
        }
        .width('100%')
        .layoutWeight(1)
        .margin({ bottom: 20 })

        // æ“ä½œæŒ‰é’®
        Row({ space: 12 }) {
          Button('å–æ¶ˆ')
            .width(100)
            .height(40)
            .backgroundColor('#f0f0f0')
            .fontColor('#666')
            .onClick(() => {
              this.showNodeForm = false;
              this.resetNodeForm();
            })

          Button('åˆ›å»º')
            .width(100)
            .height(40)
            .backgroundColor('#007dff')
            .fontColor(Color.White)
            .onClick(() => {
              this.handleCreateNode();
            })
        }
      }
      .width('90%')
      .height('80%')
      .padding(20)
      .backgroundColor(Color.White)
      .borderRadius(12)
      .shadow({ radius: 10, color: '#1a000000' })
      .align(Alignment.Center)
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  buildRelationFormModal() {
    Stack() {
      // åŠé€æ˜é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .onClick(() => {
          this.showRelationForm = false;
        })

      // è¡¨å•å†…å®¹
      Column() {
        Text('åˆ›å»ºæ–°å…³ç³»')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .margin({ bottom: 20 })

        Scroll() {
          Column({ space: 16 }) {
            // èµ·å§‹èŠ‚ç‚¹
            Column({ space: 8 }) {
              Text('èµ·å§‹èŠ‚ç‚¹:')
                .fontSize(14)
                .fontColor('#333')
              
              if (this.nodes.length === 0) {
                Text('æš‚æ— å¯ç”¨èŠ‚ç‚¹ï¼Œè¯·å…ˆåˆ›å»ºèŠ‚ç‚¹')
                  .width('100%')
                  .height(40)
                  .fontSize(14)
                  .fontColor('#999')
                  .backgroundColor('#f5f5f5')
                  .borderRadius(6)
                  .padding(10)
                  .textAlign(TextAlign.Center)
              } else {
                Column() {
                  // æ˜¾ç¤ºå½“å‰é€‰ä¸­çš„èŠ‚ç‚¹
                  Row() {
                    Text(this.nodes.find(n => n.id === this.relationForm.fromNodeId)?.title || 'é€‰æ‹©èµ·å§‹èŠ‚ç‚¹')
                      .fontSize(14)
                      .fontColor(this.relationForm.fromNodeId ? '#333' : '#999')
                      .layoutWeight(1)
                      .padding(10)
                    
                    Button('â–¼')
                      .fontSize(12)
                      .width(40)
                      .height(40)
                      .backgroundColor('#e8e8e8')
                      .fontColor('#666')
                      .onClick(() => {
                        this.showFromNodePicker = !this.showFromNodePicker;
                        this.showToNodePicker = false;
                        this.showRelationTypePicker = false;
                      })
                  }
                  .width('100%')
                  .height(40)
                  .backgroundColor('#f5f5f5')
                  .borderRadius(6)
                  .onClick(() => {
                    this.showFromNodePicker = !this.showFromNodePicker;
                    this.showToNodePicker = false;
                    this.showRelationTypePicker = false;
                  })

                  // èŠ‚ç‚¹é€‰æ‹©å™¨
                  if (this.showFromNodePicker) {
                    Column() {
                      ForEach(this.nodes, (node: Node, index?: number) => {
                        Row() {
                          Text(node.title)
                            .fontSize(14)
                            .fontColor('#333')
                            .layoutWeight(1)
                            .padding(12)
                          
                          if (node.id === this.relationForm.fromNodeId) {
                            Text('âœ“')
                              .fontSize(14)
                              .fontColor('#52c41a')
                              .margin({ right: 12 })
                          }
                        }
                        .width('100%')
                        .backgroundColor(node.id === this.relationForm.fromNodeId ? '#f0f9ff' : Color.White)
                        .border({ width: { bottom: 1 }, color: '#f0f0f0' })
                        .onClick(() => {
                          this.relationForm = {
                            fromNodeId: node.id,
                            toNodeId: this.relationForm.toNodeId,
                            type: this.relationForm.type,
                            label: this.relationForm.label,
                            weight: this.relationForm.weight
                          };
                          this.showFromNodePicker = false;
                        })
                      })
                    }
                    .width('100%')
                    .height(200)
                    .backgroundColor(Color.White)
                    .borderRadius(6)
                    .border({ width: 1, color: '#d9d9d9' })
                    .shadow({ radius: 4, color: '#1a000000' })
                    .margin({ top: 4 })
                    .zIndex(10)
                  }
                }
              }
            }

            // ç›®æ ‡èŠ‚ç‚¹
            Column({ space: 8 }) {
              Text('ç›®æ ‡èŠ‚ç‚¹:')
                .fontSize(14)
                .fontColor('#333')
              
              if (this.nodes.length === 0) {
                Text('æš‚æ— å¯ç”¨èŠ‚ç‚¹ï¼Œè¯·å…ˆåˆ›å»ºèŠ‚ç‚¹')
                  .width('100%')
                  .height(40)
                  .fontSize(14)
                  .fontColor('#999')
                  .backgroundColor('#f5f5f5')
                  .borderRadius(6)
                  .padding(10)
                  .textAlign(TextAlign.Center)
              } else {
                Column() {
                  // æ˜¾ç¤ºå½“å‰é€‰ä¸­çš„èŠ‚ç‚¹
                  Row() {
                    Text(this.nodes.find(n => n.id === this.relationForm.toNodeId)?.title || 'é€‰æ‹©ç›®æ ‡èŠ‚ç‚¹')
                      .fontSize(14)
                      .fontColor(this.relationForm.toNodeId ? '#333' : '#999')
                      .layoutWeight(1)
                      .padding(10)
                    
                    Button('â–¼')
                      .fontSize(12)
                      .width(40)
                      .height(40)
                      .backgroundColor('#e8e8e8')
                      .fontColor('#666')
                      .onClick(() => {
                        this.showToNodePicker = !this.showToNodePicker;
                        this.showFromNodePicker = false;
                        this.showRelationTypePicker = false;
                      })
                  }
                  .width('100%')
                  .height(40)
                  .backgroundColor('#f5f5f5')
                  .borderRadius(6)
                  .onClick(() => {
                    this.showToNodePicker = !this.showToNodePicker;
                    this.showFromNodePicker = false;
                    this.showRelationTypePicker = false;
                  })

                  // èŠ‚ç‚¹é€‰æ‹©å™¨
                  if (this.showToNodePicker) {
                    Column() {
                      ForEach(this.nodes, (node: Node, index?: number) => {
                        Row() {
                          Text(node.title)
                            .fontSize(14)
                            .fontColor('#333')
                            .layoutWeight(1)
                            .padding(12)
                          
                          if (node.id === this.relationForm.toNodeId) {
                            Text('âœ“')
                              .fontSize(14)
                              .fontColor('#52c41a')
                              .margin({ right: 12 })
                          }
                        }
                        .width('100%')
                        .backgroundColor(node.id === this.relationForm.toNodeId ? '#f0f9ff' : Color.White)
                        .border({ width: { bottom: 1 }, color: '#f0f0f0' })
                        .onClick(() => {
                          this.relationForm = {
                            fromNodeId: this.relationForm.fromNodeId,
                            toNodeId: node.id,
                            type: this.relationForm.type,
                            label: this.relationForm.label,
                            weight: this.relationForm.weight
                          };
                          this.showToNodePicker = false;
                        })
                      })
                    }
                    .width('100%')
                    .height(200)
                    .backgroundColor(Color.White)
                    .borderRadius(6)
                    .border({ width: 1, color: '#d9d9d9' })
                    .shadow({ radius: 4, color: '#1a000000' })
                    .margin({ top: 4 })
                    .zIndex(10)
                  }
                }
              }
            }

            // å…³ç³»ç±»å‹
            Column({ space: 8 }) {
              Text('å…³ç³»ç±»å‹:')
                .fontSize(14)
                .fontColor('#333')
              
              Column() {
                // æ˜¾ç¤ºå½“å‰é€‰ä¸­çš„å…³ç³»ç±»å‹
                Row() {
                  Text(this.getRelationTypeLabel(this.relationForm.type))
                    .fontSize(14)
                    .fontColor('#333')
                    .layoutWeight(1)
                    .padding(10)
                  
                  Button('â–¼')
                    .fontSize(12)
                    .width(40)
                    .height(40)
                    .backgroundColor('#e8e8e8')
                    .fontColor('#666')
                    .onClick(() => {
                      this.showRelationTypePicker = !this.showRelationTypePicker;
                      this.showFromNodePicker = false;
                      this.showToNodePicker = false;
                    })
                }
                .width('100%')
                .height(40)
                .backgroundColor('#f5f5f5')
                .borderRadius(6)
                .onClick(() => {
                  this.showRelationTypePicker = !this.showRelationTypePicker;
                  this.showFromNodePicker = false;
                  this.showToNodePicker = false;
                })

                // å…³ç³»ç±»å‹é€‰æ‹©å™¨
                if (this.showRelationTypePicker) {
                  Column() {
                    ForEach(this.relationTypes, (type: RelationType, index?: number) => {
                      Row() {
                        Text(this.getRelationTypeLabel(type))
                          .fontSize(14)
                          .fontColor('#333')
                          .layoutWeight(1)
                          .padding(12)
                        
                        if (type === this.relationForm.type) {
                          Text('âœ“')
                            .fontSize(14)
                            .fontColor('#52c41a')
                            .margin({ right: 12 })
                        }
                      }
                      .width('100%')
                      .backgroundColor(type === this.relationForm.type ? '#f0f9ff' : Color.White)
                      .border({ width: { bottom: 1 }, color: '#f0f0f0' })
                      .onClick(() => {
                        this.relationForm = {
                          fromNodeId: this.relationForm.fromNodeId,
                          toNodeId: this.relationForm.toNodeId,
                          type: type,
                          label: this.relationForm.label,
                          weight: this.relationForm.weight
                        };
                        this.showRelationTypePicker = false;
                      })
                    })
                  }
                  .width('100%')
                  .backgroundColor(Color.White)
                  .borderRadius(6)
                  .border({ width: 1, color: '#d9d9d9' })
                  .shadow({ radius: 4, color: '#1a000000' })
                  .margin({ top: 4 })
                  .zIndex(10)
                }
              }
            }

            // æƒé‡
            Column({ space: 8 }) {
              Text('æƒé‡ (0-1):')
                .fontSize(14)
                .fontColor('#333')
              
              TextInput({ placeholder: '0.5' })
                .width('100%')
                .height(40)
                .fontSize(14)
                .backgroundColor('#f5f5f5')
                .borderRadius(6)
                .type(InputType.Number)
                .onChange((value: string) => {
                  let weight = parseFloat(value);
                  if (!isNaN(weight) && weight >= 0 && weight <= 1) {
                    this.relationForm.weight = weight;
                  }
                })
            }
          }
          .width('100%')
        }
        .width('100%')
        .layoutWeight(1)
        .margin({ bottom: 20 })

        // æ“ä½œæŒ‰é’®
        Row({ space: 12 }) {
          Button('å–æ¶ˆ')
            .width(100)
            .height(40)
            .backgroundColor('#f0f0f0')
            .fontColor('#666')
            .onClick(() => {
              this.showRelationForm = false;
              this.resetRelationForm();
            })

          Button('åˆ›å»º')
            .width(100)
            .height(40)
            .backgroundColor('#007dff')
            .fontColor(Color.White)
            .onClick(() => {
              this.handleCreateRelation();
            })
        }
      }
      .width('90%')
      .height('80%')
      .padding(20)
      .backgroundColor(Color.White)
      .borderRadius(12)
      .shadow({ radius: 10, color: '#1a000000' })
      .align(Alignment.Center)
    }
    .width('100%')
    .height('100%')
  }

  // --- é€»è¾‘æ–¹æ³• ---

  // è·å–å›¾è°±æ•°æ®
  async fetchGraphData() {
    this.isLoading = true;
    this.errorMessage = '';

    try {
      const responses = await Promise.all([
        this.graphController.listNodes(this.courseId),
        this.graphController.listRelations(this.courseId)
      ]);
      
      const nodesResponse = responses[0];
      const relationsResponse = responses[1];

      if (nodesResponse.success && nodesResponse.data) {
        this.nodes = nodesResponse.data;
      } else {
        this.errorMessage = nodesResponse.message || 'è·å–èŠ‚ç‚¹å¤±è´¥';
        return;
      }

      if (relationsResponse.success && relationsResponse.data) {
        this.relations = relationsResponse.data;
      } else {
        this.errorMessage = relationsResponse.message || 'è·å–å…³ç³»å¤±è´¥';
        return;
      }
    } catch (error) {
      this.errorMessage = 'è·å–çŸ¥è¯†å›¾è°±æ•°æ®å¤±è´¥: ' + (error as Error).message;
      console.error('Error fetching graph data:', error);
    } finally {
      this.isLoading = false;
    }
  }

  // åˆ›å»ºèŠ‚ç‚¹
  async handleCreateNode() {
    console.log('å¼€å§‹åˆ›å»ºèŠ‚ç‚¹ï¼Œè¡¨å•æ•°æ®:', this.nodeForm);
    console.log('è¯¾ç¨‹ID:', this.courseId);
    
    if (!this.nodeForm.title.trim()) {
      console.log('èŠ‚ç‚¹æ ‡é¢˜ä¸ºç©º');
      promptAction.showToast({ message: 'è¯·è¾“å…¥èŠ‚ç‚¹æ ‡é¢˜' });
      return;
    }

    try {
      const nodeData: CreateNodeRequest = {
        title: this.nodeForm.title,
        label: this.nodeForm.title, // ä½¿ç”¨æ ‡é¢˜ä½œä¸ºæ ‡ç­¾
        type: this.nodeForm.type,
        content: this.nodeForm.content || undefined,
        position: { x: Math.random() * 800, y: Math.random() * 600 }
      };

      console.log('å‡†å¤‡å‘é€çš„èŠ‚ç‚¹æ•°æ®:', nodeData);
      const result = await this.graphController.createNode(this.courseId, nodeData);
      console.log('åˆ›å»ºèŠ‚ç‚¹ç»“æœ:', result);
      
      if (result.success) {
        promptAction.showToast({ message: 'èŠ‚ç‚¹åˆ›å»ºæˆåŠŸ' });
        this.showNodeForm = false;
        this.resetNodeForm();
        this.fetchGraphData();
      } else {
        console.log('åˆ›å»ºèŠ‚ç‚¹å¤±è´¥:', result.message);
        promptAction.showToast({ message: result.message || 'åˆ›å»ºèŠ‚ç‚¹å¤±è´¥' });
      }
    } catch (error) {
      console.error('åˆ›å»ºèŠ‚ç‚¹å¼‚å¸¸:', error);
      promptAction.showToast({ message: 'åˆ›å»ºèŠ‚ç‚¹æ—¶å‘ç”Ÿå¼‚å¸¸' });
    }
  }

  // åˆ›å»ºå…³ç³»
  async handleCreateRelation() {
    if (!this.relationForm.fromNodeId || !this.relationForm.toNodeId) {
      promptAction.showToast({ message: 'è¯·é€‰æ‹©èµ·å§‹å’Œç›®æ ‡èŠ‚ç‚¹' });
      return;
    }

    if (this.relationForm.fromNodeId === this.relationForm.toNodeId) {
      promptAction.showToast({ message: 'èµ·å§‹èŠ‚ç‚¹å’Œç›®æ ‡èŠ‚ç‚¹ä¸èƒ½ç›¸åŒ' });
      return;
    }

    try {
      // åç«¯APIæœŸæœ›çš„å­—æ®µåæ˜¯ from, to, type
      const relationData: ApiCreateRelationRequest = {
        from: this.relationForm.fromNodeId,
        to: this.relationForm.toNodeId,
        type: this.relationForm.type,
        label: this.relationForm.label || undefined,
        weight: this.relationForm.weight
      };

      const result = await this.graphController.createRelation(this.courseId, relationData);
      
      if (result.success) {
        promptAction.showToast({ message: 'å…³ç³»åˆ›å»ºæˆåŠŸ' });
        this.showRelationForm = false;
        this.resetRelationForm();
        this.fetchGraphData();
      } else {
        promptAction.showToast({ message: result.message || 'åˆ›å»ºå…³ç³»å¤±è´¥' });
      }
    } catch (error) {
      promptAction.showToast({ message: 'åˆ›å»ºå…³ç³»æ—¶å‘ç”Ÿå¼‚å¸¸' });
      console.error('Error creating relation:', error);
    }
  }

  // åˆ é™¤èŠ‚ç‚¹
  async handleDeleteNode(nodeId: string) {
    try {
      const result = await promptAction.showDialog({
        title: 'åˆ é™¤èŠ‚ç‚¹',
        message: 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèŠ‚ç‚¹å—ï¼Ÿè¿™å¯èƒ½ä¼šå½±å“ç›¸å…³çš„å…³ç³»ã€‚',
        buttons: [
          { text: 'å–æ¶ˆ', color: '#666' },
          { text: 'åˆ é™¤', color: '#ff0000' }
        ]
      });

      if (result.index === 1) {
        const deleteResult = await this.graphController.deleteNode(this.courseId, nodeId);
        
        if (deleteResult.success) {
          promptAction.showToast({ message: 'èŠ‚ç‚¹åˆ é™¤æˆåŠŸ' });
          if (this.selectedNode?.id === nodeId) {
            this.selectedNode = null;
          }
          this.fetchGraphData();
        } else {
          promptAction.showToast({ message: deleteResult.message || 'åˆ é™¤èŠ‚ç‚¹å¤±è´¥' });
        }
      }
    } catch (error) {
      promptAction.showToast({ message: 'åˆ é™¤èŠ‚ç‚¹æ—¶å‘ç”Ÿå¼‚å¸¸' });
      console.error('Error deleting node:', error);
    }
  }

  // åˆ é™¤å…³ç³»
  async handleDeleteRelation(relationId: string) {
    try {
      const result = await promptAction.showDialog({
        title: 'åˆ é™¤å…³ç³»',
        message: 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå…³ç³»å—ï¼Ÿ',
        buttons: [
          { text: 'å–æ¶ˆ', color: '#666' },
          { text: 'åˆ é™¤', color: '#ff0000' }
        ]
      });

      if (result.index === 1) {
        const deleteResult = await this.graphController.deleteRelation(this.courseId, relationId);
        
        if (deleteResult.success) {
          promptAction.showToast({ message: 'å…³ç³»åˆ é™¤æˆåŠŸ' });
          this.fetchGraphData();
        } else {
          promptAction.showToast({ message: deleteResult.message || 'åˆ é™¤å…³ç³»å¤±è´¥' });
        }
      }
    } catch (error) {
      promptAction.showToast({ message: 'åˆ é™¤å…³ç³»æ—¶å‘ç”Ÿå¼‚å¸¸' });
      console.error('Error deleting relation:', error);
    }
  }

  // è·å–èŠ‚ç‚¹çš„å…¥è¾¹å…³ç³»
  getIncomingRelations(nodeId: string): Relation[] {
    return this.relations.filter(r => r.toNodeId === nodeId);
  }

  // è·å–èŠ‚ç‚¹çš„å‡ºè¾¹å…³ç³»
  getOutgoingRelations(nodeId: string): Relation[] {
    return this.relations.filter(r => r.fromNodeId === nodeId);
  }

  // è·å–å…³ç³»ç±»å‹æ ‡ç­¾
  getRelationTypeLabel(type: RelationType): string {
    switch (type) {
      case RelationType.PREREQUISITE:
        return 'å‰ç½®çŸ¥è¯†';
      case RelationType.RELATED:
        return 'ç›¸å…³æ¦‚å¿µ';
      case RelationType.CONTAINS:
        return 'åŒ…å«å…³ç³»';
      case RelationType.EXAMPLES:
        return 'ç¤ºä¾‹å…³ç³»';
      default:
        return type;
    }
  }

  // é‡ç½®èŠ‚ç‚¹è¡¨å•
  resetNodeForm() {
    this.nodeForm = {
      title: '',
      type: NodeType.CONCEPT,
      content: ''
    };
  }

  // åˆå§‹åŒ–å…³ç³»è¡¨å•
  initializeRelationForm() {
    console.log('initializeRelationForm - èŠ‚ç‚¹æ•°é‡:', this.nodes.length);
    console.log('initializeRelationForm - èŠ‚ç‚¹æ•°æ®:', this.nodes);
    
    // ç›´æ¥åˆ›å»ºæ–°çš„è¡¨å•å¯¹è±¡ï¼ŒåŒ…å«é»˜è®¤çš„èŠ‚ç‚¹é€‰æ‹©
    if (this.nodes.length > 0) {
      const fromNodeId = this.nodes[0].id;
      const toNodeId = this.nodes.length > 1 ? this.nodes[1].id : this.nodes[0].id;
      
      console.log('è®¾ç½®é»˜è®¤èŠ‚ç‚¹ - from:', fromNodeId, 'to:', toNodeId);
      
      this.relationForm = {
        fromNodeId: fromNodeId,
        toNodeId: toNodeId,
        type: RelationType.RELATED,
        label: '',
        weight: 0.5
      };
      this.showFromNodePicker = false;
      this.showToNodePicker = false;
      this.showRelationTypePicker = false;
      
      console.log('è¡¨å•åˆå§‹åŒ–å®Œæˆ:', this.relationForm);
    } else {
      console.log('æ²¡æœ‰å¯ç”¨èŠ‚ç‚¹ï¼Œé‡ç½®è¡¨å•');
      // å¦‚æœæ²¡æœ‰èŠ‚ç‚¹ï¼Œé‡ç½®ä¸ºç©ºè¡¨å•
      this.relationForm = {
        fromNodeId: '',
        toNodeId: '',
        type: RelationType.RELATED,
        label: '',
        weight: 0.5
      };
      this.showFromNodePicker = false;
      this.showToNodePicker = false;
      this.showRelationTypePicker = false;
    }
  }

  // é‡ç½®å…³ç³»è¡¨å•
  resetRelationForm() {
    this.relationForm = {
      fromNodeId: '',
      toNodeId: '',
      type: RelationType.RELATED,
      label: '',
      weight: 0.5
    };
    this.showFromNodePicker = false;
    this.showToNodePicker = false;
    this.showRelationTypePicker = false;
  }
}